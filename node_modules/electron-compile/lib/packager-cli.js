#!/usr/bin/env node
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.packagerMain = exports.runAsarArchive = exports.packageDirToResourcesDir = undefined;

let packageDirToResourcesDir = exports.packageDirToResourcesDir = (() => {
  var _ref = _asyncToGenerator(function* (packageDir) {
    let appDir = (yield _promise.pfs.readdir(packageDir)).find(function (x) {
      return x.match(/\.app$/i);
    });
    if (appDir) {
      return _path2.default.join(packageDir, appDir, 'Contents', 'Resources', 'app');
    } else {
      return _path2.default.join(packageDir, 'resources', 'app');
    }
  });

  return function packageDirToResourcesDir(_x) {
    return _ref.apply(this, arguments);
  };
})();

let copySmallFile = (() => {
  var _ref2 = _asyncToGenerator(function* (from, to) {
    d(`Copying ${ from } => ${ to }`);

    let buf = yield _promise.pfs.readFile(from);
    yield _promise.pfs.writeFile(to, buf);
  });

  return function copySmallFile(_x2, _x3) {
    return _ref2.apply(this, arguments);
  };
})();

let compileAndShim = (() => {
  var _ref3 = _asyncToGenerator(function* (packageDir) {
    let appDir = yield packageDirToResourcesDir(packageDir);

    d(`Looking in ${ appDir }`);
    for (let entry of yield _promise.pfs.readdir(appDir)) {
      if (entry.match(/^(node_modules|bower_components)$/)) continue;

      let fullPath = _path2.default.join(appDir, entry);
      let stat = yield _promise.pfs.stat(fullPath);

      if (!stat.isDirectory()) continue;

      d(`Executing electron-compile: ${ appDir } => ${ entry }`);
      yield (0, _cli.main)(appDir, [fullPath]);
    }

    d('Copying in es6-shim');
    let packageJson = JSON.parse((yield _promise.pfs.readFile(_path2.default.join(appDir, 'package.json'), 'utf8')));

    let index = packageJson.main || 'index.js';
    packageJson.originalMain = index;
    packageJson.main = 'es6-shim.js';

    yield copySmallFile(_path2.default.join(__dirname, 'es6-shim.js'), _path2.default.join(appDir, 'es6-shim.js'));

    yield _promise.pfs.writeFile(_path2.default.join(appDir, 'package.json'), JSON.stringify(packageJson, null, 2));
  });

  return function compileAndShim(_x4) {
    return _ref3.apply(this, arguments);
  };
})();

let runAsarArchive = exports.runAsarArchive = (() => {
  var _ref4 = _asyncToGenerator(function* (packageDir, asarUnpackDir) {
    let appDir = yield packageDirToResourcesDir(packageDir);

    let asarArgs = ['pack', 'app', 'app.asar'];
    if (asarUnpackDir) {
      asarArgs.push('--unpack-dir', asarUnpackDir);
    }

    var _findExecutableOrGues = findExecutableOrGuess('asar', asarArgs);

    let cmd = _findExecutableOrGues.cmd,
        args = _findExecutableOrGues.args;


    d(`Running ${ cmd } ${ JSON.stringify(args) }`);
    yield (0, _spawnRx.spawnPromise)(cmd, args, { cwd: _path2.default.join(appDir, '..') });
    _rimraf2.default.sync(_path2.default.join(appDir));
  });

  return function runAsarArchive(_x5, _x6) {
    return _ref4.apply(this, arguments);
  };
})();

let packagerMain = exports.packagerMain = (() => {
  var _ref5 = _asyncToGenerator(function* (argv) {
    d(`argv: ${ JSON.stringify(argv) }`);
    argv = argv.splice(2);

    var _splitOutAsarArgument = splitOutAsarArguments(argv);

    let packagerArgs = _splitOutAsarArgument.packagerArgs,
        asarArgs = _splitOutAsarArgument.asarArgs;

    var _findExecutableOrGues2 = findExecutableOrGuess(electronPackager, packagerArgs);

    let cmd = _findExecutableOrGues2.cmd,
        args = _findExecutableOrGues2.args;


    d(`Spawning electron-packager: ${ JSON.stringify(args) }`);
    let packagerOutput = yield (0, _spawnRx.spawnPromise)(cmd, args);
    let packageDirs = parsePackagerOutput(packagerOutput);

    d(`Starting compilation for ${ JSON.stringify(packageDirs) }`);
    for (let packageDir of packageDirs) {
      yield compileAndShim(packageDir);

      if (!asarArgs) continue;

      d('Starting ASAR packaging');
      let asarUnpackDir = null;
      if (asarArgs.length === 2) {
        asarUnpackDir = asarArgs[1];
      }

      yield runAsarArchive(packageDir, asarUnpackDir);
    }
  });

  return function packagerMain(_x7) {
    return _ref5.apply(this, arguments);
  };
})();

exports.splitOutAsarArguments = splitOutAsarArguments;
exports.parsePackagerOutput = parsePackagerOutput;
exports.findExecutableOrGuess = findExecutableOrGuess;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

var _promise = require('./promise');

var _cli = require('./cli');

var _spawnRx = require('spawn-rx');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const d = require('debug-electron')('electron-compile:packager');
const electronPackager = 'electron-packager';

function splitOutAsarArguments(argv) {
  if (argv.find(x => x.match(/^--asar-unpack$/))) {
    throw new Error("electron-compile doesn't support --asar-unpack at the moment, use asar-unpack-dir");
  }

  // Strip --asar altogether
  let ret = argv.filter(x => !x.match(/^--asar/));

  if (ret.length === argv.length) {
    return { packagerArgs: ret, asarArgs: null };
  }

  let indexOfUnpack = ret.findIndex(x => x.match(/^--asar-unpack-dir$/));
  if (indexOfUnpack < 0) {
    return { packagerArgs: ret, asarArgs: [] };
  }

  let unpackArgs = ret.slice(indexOfUnpack, indexOfUnpack + 1);
  let notUnpackArgs = ret.slice(0, indexOfUnpack).concat(ret.slice(indexOfUnpack + 2));

  return { packagerArgs: notUnpackArgs, asarArgs: unpackArgs };
}

function parsePackagerOutput(output) {
  // NB: Yes, this is fragile as fuck. :-/
  console.log(output);
  let lines = output.split('\n');

  let idx = lines.findIndex(x => x.match(/Wrote new app/i));
  if (idx < 1) throw new Error(`Packager output is invalid: ${ output }`);
  lines = lines.splice(idx);

  // Multi-platform case
  if (lines[0].match(/Wrote new apps/)) {
    return lines.splice(1).filter(x => x.length > 1);
  } else {
    return [lines[0].replace(/^.*new app to /, '')];
  }
}

function findExecutableOrGuess(cmdToFind, argsToUse) {
  var _findActualExecutable = (0, _spawnRx.findActualExecutable)(cmdToFind, argsToUse);

  let cmd = _findActualExecutable.cmd,
      args = _findActualExecutable.args;

  if (cmd === electronPackager) {
    d(`Can't find ${ cmdToFind }, falling back to where it should be as a guess!`);
    let cmdSuffix = process.platform === 'win32' ? '.cmd' : '';
    return (0, _spawnRx.findActualExecutable)(_path2.default.resolve(__dirname, '..', '..', '.bin', `${ cmdToFind }${ cmdSuffix }`), argsToUse);
  }

  return { cmd, args };
}

if (process.mainModule === module) {
  packagerMain(process.argv).then(() => process.exit(0)).catch(e => {
    console.error(e.message || e);
    d(e.stack);

    process.exit(-1);
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYWNrYWdlci1jbGkuanMiXSwibmFtZXMiOlsicGFja2FnZURpciIsImFwcERpciIsInJlYWRkaXIiLCJmaW5kIiwieCIsIm1hdGNoIiwiam9pbiIsInBhY2thZ2VEaXJUb1Jlc291cmNlc0RpciIsImZyb20iLCJ0byIsImQiLCJidWYiLCJyZWFkRmlsZSIsIndyaXRlRmlsZSIsImNvcHlTbWFsbEZpbGUiLCJlbnRyeSIsImZ1bGxQYXRoIiwic3RhdCIsImlzRGlyZWN0b3J5IiwicGFja2FnZUpzb24iLCJKU09OIiwicGFyc2UiLCJpbmRleCIsIm1haW4iLCJvcmlnaW5hbE1haW4iLCJfX2Rpcm5hbWUiLCJzdHJpbmdpZnkiLCJjb21waWxlQW5kU2hpbSIsImFzYXJVbnBhY2tEaXIiLCJhc2FyQXJncyIsInB1c2giLCJmaW5kRXhlY3V0YWJsZU9yR3Vlc3MiLCJjbWQiLCJhcmdzIiwiY3dkIiwic3luYyIsInJ1bkFzYXJBcmNoaXZlIiwiYXJndiIsInNwbGljZSIsInNwbGl0T3V0QXNhckFyZ3VtZW50cyIsInBhY2thZ2VyQXJncyIsImVsZWN0cm9uUGFja2FnZXIiLCJwYWNrYWdlck91dHB1dCIsInBhY2thZ2VEaXJzIiwicGFyc2VQYWNrYWdlck91dHB1dCIsImxlbmd0aCIsInBhY2thZ2VyTWFpbiIsInJlcXVpcmUiLCJFcnJvciIsInJldCIsImZpbHRlciIsImluZGV4T2ZVbnBhY2siLCJmaW5kSW5kZXgiLCJ1bnBhY2tBcmdzIiwic2xpY2UiLCJub3RVbnBhY2tBcmdzIiwiY29uY2F0Iiwib3V0cHV0IiwiY29uc29sZSIsImxvZyIsImxpbmVzIiwic3BsaXQiLCJpZHgiLCJyZXBsYWNlIiwiY21kVG9GaW5kIiwiYXJnc1RvVXNlIiwiY21kU3VmZml4IiwicHJvY2VzcyIsInBsYXRmb3JtIiwicmVzb2x2ZSIsIm1haW5Nb2R1bGUiLCJtb2R1bGUiLCJ0aGVuIiwiZXhpdCIsImNhdGNoIiwiZSIsImVycm9yIiwibWVzc2FnZSIsInN0YWNr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QyxtQ0FBcUJELFNBQXJCLEVBQWdDQyxTQUFoQyxDQURzQzs7QUFBQSxNQUNwRGpDLEdBRG9ELHlCQUNwREEsR0FEb0Q7QUFBQSxNQUMvQ0MsSUFEK0MseUJBQy9DQSxJQUQrQzs7QUFFMUQsTUFBSUQsUUFBUVMsZ0JBQVosRUFBOEI7QUFDNUIvQixNQUFHLGVBQWFzRCxTQUFVLG1EQUExQjtBQUNBLFFBQUlFLFlBQVlDLFFBQVFDLFFBQVIsS0FBcUIsT0FBckIsR0FBK0IsTUFBL0IsR0FBd0MsRUFBeEQ7QUFDQSxXQUFPLG1DQUFxQixlQUFLQyxPQUFMLENBQWE1QyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLE1BQXBDLEVBQTZDLElBQUV1QyxTQUFVLEtBQUVFLFNBQVUsR0FBckUsQ0FBckIsRUFBOEZELFNBQTlGLENBQVA7QUFDRDs7QUFFRCxTQUFPLEVBQUVqQyxHQUFGLEVBQU9DLElBQVAsRUFBUDtBQUNEOztBQTZCRCxJQUFJa0MsUUFBUUcsVUFBUixLQUF1QkMsTUFBM0IsRUFBbUM7QUFDakN6QixlQUFhcUIsUUFBUTlCLElBQXJCLEVBQ0dtQyxJQURILENBQ1EsTUFBTUwsUUFBUU0sSUFBUixDQUFhLENBQWIsQ0FEZCxFQUVHQyxLQUZILENBRVVDLENBQUQsSUFBTztBQUNaakIsWUFBUWtCLEtBQVIsQ0FBY0QsRUFBRUUsT0FBRixJQUFhRixDQUEzQjtBQUNBakUsTUFBRWlFLEVBQUVHLEtBQUo7O0FBRUFYLFlBQVFNLElBQVIsQ0FBYSxDQUFDLENBQWQ7QUFDRCxHQVBIO0FBUUQiLCJmaWxlIjoicGFja2FnZXItY2xpLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcblxyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xyXG5cclxuaW1wb3J0IHtwZnN9IGZyb20gJy4vcHJvbWlzZSc7XHJcbmltcG9ydCB7bWFpbn0gZnJvbSAnLi9jbGknO1xyXG5cclxuaW1wb3J0IHtzcGF3blByb21pc2UsIGZpbmRBY3R1YWxFeGVjdXRhYmxlfSBmcm9tICdzcGF3bi1yeCc7XHJcblxyXG5jb25zdCBkID0gcmVxdWlyZSgnZGVidWctZWxlY3Ryb24nKSgnZWxlY3Ryb24tY29tcGlsZTpwYWNrYWdlcicpO1xyXG5jb25zdCBlbGVjdHJvblBhY2thZ2VyID0gJ2VsZWN0cm9uLXBhY2thZ2VyJztcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwYWNrYWdlRGlyVG9SZXNvdXJjZXNEaXIocGFja2FnZURpcikge1xyXG4gIGxldCBhcHBEaXIgPSAoYXdhaXQgcGZzLnJlYWRkaXIocGFja2FnZURpcikpLmZpbmQoKHgpID0+IHgubWF0Y2goL1xcLmFwcCQvaSkpO1xyXG4gIGlmIChhcHBEaXIpIHtcclxuICAgIHJldHVybiBwYXRoLmpvaW4ocGFja2FnZURpciwgYXBwRGlyLCAnQ29udGVudHMnLCAnUmVzb3VyY2VzJywgJ2FwcCcpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gcGF0aC5qb2luKHBhY2thZ2VEaXIsICdyZXNvdXJjZXMnLCAnYXBwJyk7XHJcbiAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBjb3B5U21hbGxGaWxlKGZyb20sIHRvKSB7XHJcbiAgZChgQ29weWluZyAke2Zyb219ID0+ICR7dG99YCk7XHJcblxyXG4gIGxldCBidWYgPSBhd2FpdCBwZnMucmVhZEZpbGUoZnJvbSk7XHJcbiAgYXdhaXQgcGZzLndyaXRlRmlsZSh0bywgYnVmKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNwbGl0T3V0QXNhckFyZ3VtZW50cyhhcmd2KSB7XHJcbiAgaWYgKGFyZ3YuZmluZCgoeCkgPT4geC5tYXRjaCgvXi0tYXNhci11bnBhY2skLykpKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJlbGVjdHJvbi1jb21waWxlIGRvZXNuJ3Qgc3VwcG9ydCAtLWFzYXItdW5wYWNrIGF0IHRoZSBtb21lbnQsIHVzZSBhc2FyLXVucGFjay1kaXJcIik7XHJcbiAgfVxyXG5cclxuICAvLyBTdHJpcCAtLWFzYXIgYWx0b2dldGhlclxyXG4gIGxldCByZXQgPSBhcmd2LmZpbHRlcigoeCkgPT4gIXgubWF0Y2goL14tLWFzYXIvKSk7XHJcblxyXG4gIGlmIChyZXQubGVuZ3RoID09PSBhcmd2Lmxlbmd0aCkgeyByZXR1cm4geyBwYWNrYWdlckFyZ3M6IHJldCwgYXNhckFyZ3M6IG51bGwgfTsgfVxyXG5cclxuICBsZXQgaW5kZXhPZlVucGFjayA9IHJldC5maW5kSW5kZXgoKHgpID0+IHgubWF0Y2goL14tLWFzYXItdW5wYWNrLWRpciQvKSk7XHJcbiAgaWYgKGluZGV4T2ZVbnBhY2sgPCAwKSB7XHJcbiAgICByZXR1cm4geyBwYWNrYWdlckFyZ3M6IHJldCwgYXNhckFyZ3M6IFtdIH07XHJcbiAgfVxyXG5cclxuICBsZXQgdW5wYWNrQXJncyA9IHJldC5zbGljZShpbmRleE9mVW5wYWNrLCBpbmRleE9mVW5wYWNrKzEpO1xyXG4gIGxldCBub3RVbnBhY2tBcmdzID0gcmV0LnNsaWNlKDAsIGluZGV4T2ZVbnBhY2spLmNvbmNhdChyZXQuc2xpY2UoaW5kZXhPZlVucGFjaysyKSk7XHJcblxyXG4gIHJldHVybiB7IHBhY2thZ2VyQXJnczogbm90VW5wYWNrQXJncywgYXNhckFyZ3M6IHVucGFja0FyZ3MgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUGFja2FnZXJPdXRwdXQob3V0cHV0KSB7XHJcbiAgLy8gTkI6IFllcywgdGhpcyBpcyBmcmFnaWxlIGFzIGZ1Y2suIDotL1xyXG4gIGNvbnNvbGUubG9nKG91dHB1dCk7XHJcbiAgbGV0IGxpbmVzID0gb3V0cHV0LnNwbGl0KCdcXG4nKTtcclxuXHJcbiAgbGV0IGlkeCA9IGxpbmVzLmZpbmRJbmRleCgoeCkgPT4geC5tYXRjaCgvV3JvdGUgbmV3IGFwcC9pKSk7XHJcbiAgaWYgKGlkeCA8IDEpIHRocm93IG5ldyBFcnJvcihgUGFja2FnZXIgb3V0cHV0IGlzIGludmFsaWQ6ICR7b3V0cHV0fWApO1xyXG4gIGxpbmVzID0gbGluZXMuc3BsaWNlKGlkeCk7XHJcblxyXG4gIC8vIE11bHRpLXBsYXRmb3JtIGNhc2VcclxuICBpZiAobGluZXNbMF0ubWF0Y2goL1dyb3RlIG5ldyBhcHBzLykpIHtcclxuICAgIHJldHVybiBsaW5lcy5zcGxpY2UoMSkuZmlsdGVyKCh4KSA9PiB4Lmxlbmd0aCA+IDEpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gW2xpbmVzWzBdLnJlcGxhY2UoL14uKm5ldyBhcHAgdG8gLywgJycpXTtcclxuICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGNvbXBpbGVBbmRTaGltKHBhY2thZ2VEaXIpIHtcclxuICBsZXQgYXBwRGlyID0gYXdhaXQgcGFja2FnZURpclRvUmVzb3VyY2VzRGlyKHBhY2thZ2VEaXIpO1xyXG5cclxuICBkKGBMb29raW5nIGluICR7YXBwRGlyfWApO1xyXG4gIGZvciAobGV0IGVudHJ5IG9mIGF3YWl0IHBmcy5yZWFkZGlyKGFwcERpcikpIHtcclxuICAgIGlmIChlbnRyeS5tYXRjaCgvXihub2RlX21vZHVsZXN8Ym93ZXJfY29tcG9uZW50cykkLykpIGNvbnRpbnVlO1xyXG5cclxuICAgIGxldCBmdWxsUGF0aCA9IHBhdGguam9pbihhcHBEaXIsIGVudHJ5KTtcclxuICAgIGxldCBzdGF0ID0gYXdhaXQgcGZzLnN0YXQoZnVsbFBhdGgpO1xyXG5cclxuICAgIGlmICghc3RhdC5pc0RpcmVjdG9yeSgpKSBjb250aW51ZTtcclxuXHJcbiAgICBkKGBFeGVjdXRpbmcgZWxlY3Ryb24tY29tcGlsZTogJHthcHBEaXJ9ID0+ICR7ZW50cnl9YCk7XHJcbiAgICBhd2FpdCBtYWluKGFwcERpciwgW2Z1bGxQYXRoXSk7XHJcbiAgfVxyXG5cclxuICBkKCdDb3B5aW5nIGluIGVzNi1zaGltJyk7XHJcbiAgbGV0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShcclxuICAgIGF3YWl0IHBmcy5yZWFkRmlsZShwYXRoLmpvaW4oYXBwRGlyLCAncGFja2FnZS5qc29uJyksICd1dGY4JykpO1xyXG5cclxuICBsZXQgaW5kZXggPSBwYWNrYWdlSnNvbi5tYWluIHx8ICdpbmRleC5qcyc7XHJcbiAgcGFja2FnZUpzb24ub3JpZ2luYWxNYWluID0gaW5kZXg7XHJcbiAgcGFja2FnZUpzb24ubWFpbiA9ICdlczYtc2hpbS5qcyc7XHJcblxyXG4gIGF3YWl0IGNvcHlTbWFsbEZpbGUoXHJcbiAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZXM2LXNoaW0uanMnKSxcclxuICAgIHBhdGguam9pbihhcHBEaXIsICdlczYtc2hpbS5qcycpKTtcclxuXHJcbiAgYXdhaXQgcGZzLndyaXRlRmlsZShcclxuICAgIHBhdGguam9pbihhcHBEaXIsICdwYWNrYWdlLmpzb24nKSxcclxuICAgIEpTT04uc3RyaW5naWZ5KHBhY2thZ2VKc29uLCBudWxsLCAyKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5Bc2FyQXJjaGl2ZShwYWNrYWdlRGlyLCBhc2FyVW5wYWNrRGlyKSB7XHJcbiAgbGV0IGFwcERpciA9IGF3YWl0IHBhY2thZ2VEaXJUb1Jlc291cmNlc0RpcihwYWNrYWdlRGlyKTtcclxuXHJcbiAgbGV0IGFzYXJBcmdzID0gWydwYWNrJywgJ2FwcCcsICdhcHAuYXNhciddO1xyXG4gIGlmIChhc2FyVW5wYWNrRGlyKSB7XHJcbiAgICBhc2FyQXJncy5wdXNoKCctLXVucGFjay1kaXInLCBhc2FyVW5wYWNrRGlyKTtcclxuICB9XHJcblxyXG4gIGxldCB7IGNtZCwgYXJncyB9ID0gZmluZEV4ZWN1dGFibGVPckd1ZXNzKCdhc2FyJywgYXNhckFyZ3MpO1xyXG5cclxuICBkKGBSdW5uaW5nICR7Y21kfSAke0pTT04uc3RyaW5naWZ5KGFyZ3MpfWApO1xyXG4gIGF3YWl0IHNwYXduUHJvbWlzZShjbWQsIGFyZ3MsIHsgY3dkOiBwYXRoLmpvaW4oYXBwRGlyLCAnLi4nKSB9KTtcclxuICByaW1yYWYuc3luYyhwYXRoLmpvaW4oYXBwRGlyKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kRXhlY3V0YWJsZU9yR3Vlc3MoY21kVG9GaW5kLCBhcmdzVG9Vc2UpIHtcclxuICBsZXQgeyBjbWQsIGFyZ3MgfSA9IGZpbmRBY3R1YWxFeGVjdXRhYmxlKGNtZFRvRmluZCwgYXJnc1RvVXNlKTtcclxuICBpZiAoY21kID09PSBlbGVjdHJvblBhY2thZ2VyKSB7XHJcbiAgICBkKGBDYW4ndCBmaW5kICR7Y21kVG9GaW5kfSwgZmFsbGluZyBiYWNrIHRvIHdoZXJlIGl0IHNob3VsZCBiZSBhcyBhIGd1ZXNzIWApO1xyXG4gICAgbGV0IGNtZFN1ZmZpeCA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicgPyAnLmNtZCcgOiAnJztcclxuICAgIHJldHVybiBmaW5kQWN0dWFsRXhlY3V0YWJsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLmJpbicsIGAke2NtZFRvRmluZH0ke2NtZFN1ZmZpeH1gKSwgYXJnc1RvVXNlKTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGNtZCwgYXJncyB9O1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFja2FnZXJNYWluKGFyZ3YpIHtcclxuICBkKGBhcmd2OiAke0pTT04uc3RyaW5naWZ5KGFyZ3YpfWApO1xyXG4gIGFyZ3YgPSBhcmd2LnNwbGljZSgyKTtcclxuXHJcbiAgbGV0IHsgcGFja2FnZXJBcmdzLCBhc2FyQXJncyB9ID0gc3BsaXRPdXRBc2FyQXJndW1lbnRzKGFyZ3YpO1xyXG4gIGxldCB7IGNtZCwgYXJncyB9ID0gZmluZEV4ZWN1dGFibGVPckd1ZXNzKGVsZWN0cm9uUGFja2FnZXIsIHBhY2thZ2VyQXJncyk7XHJcblxyXG4gIGQoYFNwYXduaW5nIGVsZWN0cm9uLXBhY2thZ2VyOiAke0pTT04uc3RyaW5naWZ5KGFyZ3MpfWApO1xyXG4gIGxldCBwYWNrYWdlck91dHB1dCA9IGF3YWl0IHNwYXduUHJvbWlzZShjbWQsIGFyZ3MpO1xyXG4gIGxldCBwYWNrYWdlRGlycyA9IHBhcnNlUGFja2FnZXJPdXRwdXQocGFja2FnZXJPdXRwdXQpO1xyXG5cclxuICBkKGBTdGFydGluZyBjb21waWxhdGlvbiBmb3IgJHtKU09OLnN0cmluZ2lmeShwYWNrYWdlRGlycyl9YCk7XHJcbiAgZm9yIChsZXQgcGFja2FnZURpciBvZiBwYWNrYWdlRGlycykge1xyXG4gICAgYXdhaXQgY29tcGlsZUFuZFNoaW0ocGFja2FnZURpcik7XHJcblxyXG4gICAgaWYgKCFhc2FyQXJncykgY29udGludWU7XHJcblxyXG4gICAgZCgnU3RhcnRpbmcgQVNBUiBwYWNrYWdpbmcnKTtcclxuICAgIGxldCBhc2FyVW5wYWNrRGlyID0gbnVsbDtcclxuICAgIGlmIChhc2FyQXJncy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgYXNhclVucGFja0RpciA9IGFzYXJBcmdzWzFdO1xyXG4gICAgfVxyXG5cclxuICAgIGF3YWl0IHJ1bkFzYXJBcmNoaXZlKHBhY2thZ2VEaXIsIGFzYXJVbnBhY2tEaXIpO1xyXG4gIH1cclxufVxyXG5cclxuaWYgKHByb2Nlc3MubWFpbk1vZHVsZSA9PT0gbW9kdWxlKSB7XHJcbiAgcGFja2FnZXJNYWluKHByb2Nlc3MuYXJndilcclxuICAgIC50aGVuKCgpID0+IHByb2Nlc3MuZXhpdCgwKSlcclxuICAgIC5jYXRjaCgoZSkgPT4ge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGUubWVzc2FnZSB8fCBlKTtcclxuICAgICAgZChlLnN0YWNrKTtcclxuXHJcbiAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICB9KTtcclxufVxyXG4iXX0=